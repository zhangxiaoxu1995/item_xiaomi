<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge"> -->
    <title>Document</title>
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/gouwuche.css">
    <link rel="stylesheet" href="../css/xiangqing_bottom.css">
</head>

<body>
    <div id="gouwu">
        <div id="top">
            <div class="content">
                <h1>购物车</h1>
                <p class="big_word">我的购物车</p>
                <p class="small_word">温馨提示：产品是否购买成功，以最终下单为准哦，请尽快结算</p>
                <p class="to_right">
                    <a href="denglu.html">登录</a>
                    <span>|</span>
                    <a href="zhuce.html">注册</a>
                    <a href="" class="tuichu">退出</a>
                </p>
            </div>
        </div>
        <div id="center">
            <div class="contnet">
                <ul class="shop_title clearfix">
                    <li>
                        <input type="checkbox" class="quanxuan">全选</li>
                    <li>商品名称</li>
                    <li>单价</li>
                    <li>数量</li>
                    <li>小计</li>
                    <li>操作</li>
                </ul>
                <ul class="shop_main">
                </ul>
                <ul class="jiesuan">
                    <li>继续购物</li>
                    <li>共
                        <span class="zongji_number"></span>种商品，已选择
                        <span class="zongji_small">0</span>件
                    </li>
                    <li>合计：
                        <span class="zongji_small2">0</span>元</li>
                    <li>去结算</li>
                </ul>
                <div class="cai">
                    <p class="title">
                        <span></span>买购物车中商品的人还买了
                        <span></span>
                    </p>
                    <ul class="cai_biao">
                    </ul>
                </div>
            </div>
        </div>
        <div id="buttom">
            <div id="bottoms">
                <div id="footer">
                    <div id="footer_top">
                        <div class="content">
                            <div class="footer_main1">
                                <ul class="clearfix">
                                    <li>预约维修服务</li>
                                    <li>7天无理由退货</li>
                                    <li>15天免费换货</li>
                                    <li>满150元包邮</li>
                                    <li>520余家售后网点</li>
                                </ul>
                            </div>
                            <div class="footer_main2">
                                <dl>
                                    <dt>帮助中心</dt>
                                    <dd>账户管理</dd>
                                    <dd>购物指南</dd>
                                    <dd>订单操作</dd>
                                </dl>
                                <dl>
                                    <dt>服务支持</dt>
                                    <dd>售后政策</dd>
                                    <dd>自助服务</dd>
                                    <dd>相关下载</dd>
                                </dl>
                                <dl>
                                    <dt>线下门店</dt>
                                    <dd>小米之家</dd>
                                    <dd>服务网点</dd>
                                    <dd>授权体验店</dd>
                                </dl>
                                <dl>
                                    <dt>关于小米</dt>
                                    <dd>了解小米</dd>
                                    <dd>加入小米</dd>
                                    <dd>投资者关系</dd>
                                </dl>
                                <dl>
                                    <dt>关注我们</dt>
                                    <dd>新浪微博</dd>
                                    <dd>官方微信</dd>
                                    <dd>联系我们</dd>
                                </dl>
                                <dl>
                                    <dt>特色服务</dt>
                                    <dd>F 码通道</dd>
                                    <dd>礼物码</dd>
                                    <dd>防伪查询</dd>
                                </dl>
                                <div>
                                    <p>400-100-5678</p>
                                    <p>周一至周日 8:00-18:00
                                        <br> （仅收市话费）
                                    </p>
                                    <a>人工客服</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="footer_bottom">
                        <div class="content">
                            <p>
                                <a href="###">小米商城</a>
                                <span>|</span>
                                <a href="###">MIUI</a>
                                <span>|</span>
                                <a href="###">米家</a>
                                <span>|</span>
                                <a href="###">米聊</a>
                                <span>|</span>
                                <a href="###">多看</a>
                                <span>|</span>
                                <a href="###">游戏</a>
                                <span>|</span>
                                <a href="">路由器</a>
                                <span>|</span>
                                <a href="">米粉卡</a>
                                <span>|</span>
                                <a href="">政企服务</a>
                                <span>|</span>
                                <a href="">小米天猫店</a>
                                <span>|</span>
                                <a href="">小米集团隐私政策</a>
                                <span>|</span>
                                <a href="">小米商城隐私政策</a>
                                <span>|</span>
                                <a href="">小米商城用户协议</a>
                                <span>|</span>
                                <a href="">问题反馈</a>
                                <span>|</span>
                                <a href="">廉正举报</a>
                                <span>|</span>
                                <a href="">诚信合规</a>
                                <span>|</span>
                                <a href="">Select Location</a>

                            </p>
                            <p>© mi.com 京ICP证110507号 京ICP备10046444号 京公网安备11010802020134号 京网文[2017]1530-131号
                                <br> （京）网械平台备字（2018）第00005号 互联网药品信息服务资格证 (京) -非经营性-2014-0090 营业执照 医疗器械公告
                                <br> 增值电信业务许可证  网络食品经营备案（京）【2018】WLSPJYBAHF-12   食品经营许可证
                                <br>违法和不良信息举报电话：185-0130-1238 知识产权侵权投诉 本网站所列数据，除特殊说明，所有数据均出自我司实验室测试</p>
                            <p>
                                <img src="https://i1.mifile.cn/f/i/17/site/truste.png" alt="">
                                <img src="https://s01.mifile.cn/i/v-logo-2.png" alt="">
                                <img src="https://s01.mifile.cn/i/v-logo-1.png" alt="">
                                <img src="https://s01.mifile.cn/i/v-logo-3.png" alt="">
                                <img src="https://i8.mifile.cn/b2c-mimall-media/ba10428a4f9495ac310fd0b5e0cf8370.png" alt="">
                            </p>
                            <p>
                                <img src="https://s02.mifile.cn/assets/static/image/slogan2016.png" alt="">
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script src="../jq/jquery-1.10.1.min.js"></script>
<script src="../js/uesfor.js"></script>
<script>
    ; (function () {
        //点击图标跳转到主页
        $('#top .content').on('click', 'h1', function () {
            window.open('../mian.html?');
        });
        //1、先获取cookie里的uid，通过其用户名查找对应的订单也里面的商品，
        let use_name = getcookie('name');//获取订单信息
        if (use_name) {
            $('.to_right a').eq(0).html(use_name);
            $('.to_right a').eq(1).html('我的订单');
            if ($('.to_right a').eq(0).html() == use_name) {//滑入用户名，出现退出
                $('.to_right a').eq(0).mouseover(function () {
                    $('.to_right .tuichu').css('display', 'block');
                    $('.to_right .tuichu').click(function () {//点击退出，清除cookie
                        removecookie('name');
                    })
                });
                $('.to_right .tuichu').mouseout(function () {//滑出用户名，隐藏退出
                    $('.to_right .tuichu').css('display', 'none');
                });

            }
        } else {
            $('.to_right a').eq(0).html('登录');
            if ($('.to_right a').eq(0).html() == '登录') {
                $('.to_right a').eq(0).click(function () {
                    localStorage.setItem('lujing', 'gouwuche.html')
                })
            }
            $('.to_right a').eq(1).html('注册');
        }



        let huoqu_shop_id = new Promise(resolved => {//登录状态下，能看到购物车内容
            $.ajax({
                type: 'get',
                url: '../api/gouwuche.php',
                data: {
                    use_name: use_name
                },
                success: str => {

                    let shop_main_arr = JSON.parse(str);
                    resolved(shop_main_arr);
                }
            })
        });

        huoqu_shop_id.then(shop_main_arr => {//获取shop_uid
            var uid_arr = [];
            var many_number = [];
            $('.zongji_number').html(shop_main_arr.length)//获取数据是，渲染购物车里面的商品总数量
            var shop_uid = shop_main_arr.map(function (item) {
                uid_arr.push(item.shop_uid);
                many_number.push(item.shop_many);
            });
            for (var i = 0; i < uid_arr.length; i++) {//遍历获取到的商品uid，通过循环，不断调用ajax得到商品数据
                let aaaa = many_number[i];//一起循环每个商品的数量
                $.ajax({
                    type: 'get',
                    url: '../api/xiangqing.php',
                    data: {
                        uid: uid_arr[i]
                    },
                    success: str => {//每条商品的信息
                        let juti_shop = JSON.parse(str);
                        var key = 'number_number';//为该条商品信息添加该商品数量
                        juti_shop[0][key] = aaaa;
                        let bianli = juti_shop.map(function (item) {//遍历得到的数据，将其渲染到页面中
                            var reg = /200x200/g;
                            var ss = (item.big_img).replace(reg, '80x80');
                            return ` <li data-id="${item.uid}">
                                    <div class="shop_main_one">
                                        <input type="checkbox" class="checkbox_many">
                                    </div>
                                    <img src="${ss}" alt="">
                                    <span class="shop_name">${item.list_name}</span>
                                    <span class="now_price">${item.now_price}元</span>
                                    <div class="jisuan">
                                        <span class="jian">-</span>
                                        <input type="text" value="${item.number_number}" class="number_number">
                                        <span class="jia">+</span>
                                    </div>
                                    <span class="xiaoji">${(item.now_price * item.number_number).toFixed(2)}</span>
                                    <div class="shanchu">
                                        <span>X</span>
                                    </div>
                                </li>
                            `;
                        }).join('');
                        $('.shop_main').append(bianli);//渲染li
                    }
                });
            }
        });

        //   购物车
        //数量变化
        //减
        $('.shop_main').on('click', '.jian', function () {
            let num = $(this).next().val();
            num--;
            // $(this).next().val(num);
            total($(this), num);
        });
        //加
        $('.shop_main').on('click', '.jia', function () {
            let num = $(this).prev().val();
            num++;
            // $(this).prev().val(num);
            total($(this), num);

        });
        //输入框
        $('.shop_main').on('input', '.number_number', function () {
            let num = $(this).val();
            total($(this), num);
        });

        //小计价格渲染
        function total(now, num) {//数量和小计的变化 now-点击的元素
            //数量的变化
            if (num < 1) {
                num = 1;
            }
            $(now).parent().find('.number_number').val(num);
            //更改数据库里的数量变动
            let shop_uid1 = $(now).parent().parent().attr('data-id');
            $.ajax({
                type: 'get',
                url: '../api/shengyu.php',
                data: {
                    shop_uid: shop_uid1,
                    use_name: use_name,
                    shop_many: num
                }
            })
            //小计=数量*单价
            let price = $(now).parent().prev().text().slice(0, 4);//单价
            let all = (num * price).toFixed(2);//小计
            $(now).parent().next().html(all);
            allNum();

        };

        //复选框控制总量和总价
        function checkedArr() {
            let arr = [];//存放勾选复选框的下标
            $('.shop_main_one input').each(function (index, item) {
                if ($(item).prop('checked')) {
                    //被勾选了
                    arr.push(index);
                }
            });
            return arr;
        };
        //全选按钮
        $('.shop_main').on('click', '.checkbox_many', function () {
            allNum();
        });

        //总价，总数量渲染
        function allNum() {
            let checkall = checkedArr();//返回被勾选的下标数组
            let num = 0;//放商品总数量
            let total = 0;//放总价
            checkall.forEach(function (item, index) {
                num += $('.shop_main .number_number').eq(checkall[index]).val() * 1;//累加
                total += $('.shop_main .xiaoji').eq(checkall[index]).text().slice(0) * 1;

            });
            $('.zongji_small').html(num);
            $('.zongji_small2').html(total);

            //控制全选按钮
            let len = $('.shop_main_one input').length;//本事复选框的个数

            let achecknum = $('.shop_main_one input:checked').length;
            if (len == achecknum) {
                //已经全选

                $('.quanxuan').prop('checked', true);
            } else {
                $('.quanxuan').prop('checked', false);
            }

        };

        //全选功能
        $('.quanxuan').click(function () {
            let isok = $('.quanxuan').prop('checked');
            $('.shop_main_one input').prop('checked', isok);
            allNum();
        });


        //删除按钮与操作删除数据库
        $('.shop_main').on('click', '.shanchu span', function () {
            let ok = confirm('您确定要删我吗？');
            if (ok) {
                $(this).parent().parent().remove();
            };
            allNum();
            let shanchu_shop = $(this).parents('li').attr('data-id');
            $.ajax({
                type: 'get',
                url: '../api/shanchu.php',
                data: {
                    use_name: use_name,
                    shop_uid: shanchu_shop
                }
            })
        });

        // 渲染猜你想要
        var show_like = new Promise(resolved => {
            $.ajax({
                type: 'get',
                url: '../api/show_like.php',
                success: str => {
                    let show_like_arr = JSON.parse(str);
                    resolved(show_like_arr)
                }
            })
        });
        show_like.then(show_like_arr => {
            let show_like_show = show_like_arr.map(function (item) {
                return `<li data-id='${item.uid}'>
                        <img src="${item.name_img}" alt="">
                        <p>${item.name}</p>
                        <p>${item.price}</p>
                        <p>加入购物车</p>
                    </li>`
            }).join('');
            $('.cai_biao').html(show_like_show)


        });

    })();
</script>

</html>